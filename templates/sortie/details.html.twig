{% extends 'layout.html.twig' %}

{% block main %}
    <div class="text-center py-3 addSortie">
        <div class="container-fluid">
            <div class="row">
                <div class="mx-auto col-10 bg-white p-5 col-md-10">
                    <h1>Détails de la sortie {{ sortie.nom }}</h1>
                    {% if app.user is same as(sortie.organisateur) %}
                        <p style="text-align: center"><span
                                    class="badge badge-secondary">Vous avez publié cette sortie</span>
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="container blockDetailsSortie">
        <div class="row">
            <div class="col-12">
            </div>
        </div>
        {% if sortie.etat.id == 6 %} {# sortie.etat.id == 6 corresponda à "Annulée" #}
            <div class="row">
                <div class="alert alert-warning col-12" role="alert">
                    {{ sortie.motifAnnulation }}
                </div>
            </div>
        {% endif %}

        <div class="row">
            <table class="table table-striped table-sm">
                <tr class="table-primary">
                    <th>Nom de la sortie :</th>
                    <td>{{ sortie.nom }}</td>
                </tr>
                <tr class="table-secondary">
                    <th>Date de la sortie :</th>
                    <td>{{ sortie.dateHeureDebut|date("d/m/Y à h:i") }}</td>
                </tr>
                <tr>
                    <th>Date limite d'inscription :</th>
                    <td>{{ sortie.dateLimiteInscription|date("d/m/Y") }}</td>
                </tr>
                <tr>
                    <th>Nombre de place :</th>
                    <td>{{ sortie.nbInscriptionsMax }}</td>
                </tr>
                <tr>
                    <th>Durée :</th>
                    <td>{{ sortie.duree }}</td>
                </tr>
                <tr>
                    <th>Description et infos :</th>
                    <td>{{ sortie.infosSortie }}</td>
                </tr>
                <tr>
                    <th>Ville organisatrice :</th>
                    <td>{{ sortie.organisateur.site.nom }}</td>
                </tr>
                <tr>
                    <th>Lieu :</th>
                    <td>{{ sortie.lieu.nom }}</td>
                </tr>
                <tr>
                    <th>Adresse :</th>
                    <td>{{ sortie.lieu.rue }}<br>
                        {{ sortie.lieu.ville.codePostal }} {{ sortie.lieu.ville.nom }}</td>
                </tr>
                {% if sortie.lieu.latitude is not null %}
                    <tr>
                        <th>Latitude :</th>
                        <td>{{ sortie.lieu.latitude }}</td>
                    </tr>
                {% endif %}
                {% if sortie.lieu.longitude is not null %}
                    <tr>
                        <th>Longitude :</th>
                        <td>{{ sortie.lieu.longitude }}</td>
                    </tr>
                    <tr>
                        <th colspan="2" style="text-align: center">
                            <!-- Button trigger carte GoogleMap -->
                            <a href="" data-toggle="modal" data-target="#carteSortie">
                                <i class="fas fa-map-marker-alt"></i> Voir la carte</a>
                        </th>
                    </tr>



                    <!-- Modal carte GoogleMap -->
                    <div class="modal fade" id="carteSortie" tabindex="-1" role="dialog" aria-labelledby="carteSortie"
                         aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Lieu de la
                                        sortie {{ sortie.nom }}</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div>
                                        <iframe src="http://maps.google.com/maps?q={{ sortie.lieu.latitude }}, {{ sortie.lieu.longitude }}&z=15&output=embed"
                                                width="100%" frameborder="0" style="border:0"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                {% endif %}

            </table>
        </div>


        <!-- affichage boutons -->
        <div class="row">
            {# S'INSCRIRE #}
            {# si l'utilisateur courant n'est pas l'organisateur et n'est pas déjà inscrit, il peut s'inscrire #}
            {% if app.user is not same as(sortie.organisateur) and app.user not in sortie.participants %}
                {# si la date de cloture des inscription n'est pas dépassée #}
                {% if date(sortie.dateLimiteInscription) > date() and sortie.etat.id is same as(2) %}
                    <a href="{{ url('inscription',{'id':sortie.id}) }}">
                        <button type="button" class="btn btn-primary">S'inscrire</button>
                    </a>
                {% elseif date(sortie.dateLimiteInscription) < date() %}
                    <div class="alert alert-warning" role="alert">
                        Les inscriptions sont clôturées
                    </div>
                {% endif %}
            {% endif %}

            {# SE DESISTER #}
            {# si l'utilisateur courant n'est pas l'organisateur et est déjà inscrit, il peut se désister #}
            {% if app.user is not same as(sortie.organisateur) and app.user in sortie.participants %}
                <a href="{{ url('desistement',{'id':sortie.id}) }}">
                    <button type="button" class="btn btn-primary">Se désister</button>
                </a>
            {% endif %}

            {# MODIFIER LA SORTIE #}
            {# Si l'utilisateur courant est l'ORGANISATEUR #}
            {% if app.user is same as(sortie.organisateur) %}

                {# Si la sortie n'est pas En cours, Passée, Annulée ou Archivée #}
                {% if sortie.etat.id == 1 or sortie.etat.id == 2 or sortie.etat.id == 3 %}
                    <a href="{{ url('modification',{'id':sortie.id}) }}">
                        <button type="button" class="btn btn-primary">Modifier la sortie</button>
                    </a>
                {% endif %}
            {% endif %}


            {# ANNULER LA SORTIE #}
            {# Si l'utilisateur courant est l'ORGANISATEUR ou un ADMIN #}
            {% if app.user is same as(sortie.organisateur) or app.user.administrateur %}
                {# Si la sortie n'est pas En cours, Passée, Annulée ou Archivée #}
                {% if sortie.etat.id == 1 or sortie.etat.id == 2 or sortie.etat.id == 3 %}
                    <a href="{{ url('annulation',{'id':sortie.id}) }}">
                        <button type="button" class="btn btn-danger">Annuler la sortie</button>
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- affichage des participants -->
    <div class="container-fluid blocParticipants">
        <div class="container">
            <h3>Liste des participants inscrits</h3>
            <div class="col-12">
                <table class="table table-striped">
                    <thead>
                    <th>Pseudo</th>
                    <th>Nom</th>
                    <th>Site</th>
                    </thead>
                    <tbody>
                    {% for participant in sortie.participants %}
                        <tr>
                            <td>
                                <a data-toggle="modal" data-target="#detailProfil{{ participant.id }}"
                                   href="{{ url('detail-profil',{'id':participant.id}) }}">{{ participant.username }}
                                    {% if participant is same as(sortie.organisateur) %}
                                        <span class="badge badge-primary">Organisateur</span>
                                    {% endif %}
                                </a>
                                <!-- Modal détails profils -->
                                <div class="modal fade" id="detailProfil{{ participant.id }}" tabindex="-1"
                                     role="dialog"
                                     aria-labelledby="detailProfil" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">Détails du profil
                                                    de {{ participant.username }}</h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                {{ render(controller(
                                                    'App\\Controller\\UserController::consulterProfil',
                                                    { 'id':participant.id }
                                                )) }}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </td>
                            <td>{{ participant.prenom }} {{ participant.nom|upper }}</td>
                            <td>{{ participant.site.nom }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>



{% endblock %}
